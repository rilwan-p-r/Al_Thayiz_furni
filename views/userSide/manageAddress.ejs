<%- include("./profileHeader.ejs") %>

<div class="container light-style flex-grow-1 container-p-y">
    <h4 class="font-weight-bold py-3 mb-4 " style="margin-top: 110px;">
        MY PROFILE
    </h4>
    <div class="card overflow-hidden">
        <div class="row no-gutters row-bordered row-border-light">
            <div class="col-md-3 pt-0">
                <div class="list-group list-group-flush account-settings-links">
                    <a class="list-group-item list-group-item-action" href="/userProfile">PROFILE</a>
                    <a class="list-group-item list-group-item-action" href="/editUserProfile">EDIT PROFILE</a>
                    <a class="list-group-item list-group-item-action" href="/changePassword">CHANGE PASSWORD</a>
                    <a class="list-group-item list-group-item-action" href="/orderDetails">ORDER</a>
                    <a class="list-group-item list-group-item-action active" href="/addressManage">MANAGE ADDRESS</a>
                    <a class="list-group-item list-group-item-action" href="#"></a>
                    <a class="list-group-item list-group-item-action" href="#"></a>
                </div>
            </div>

            <input type="hidden" id="userId" value="<%= user._id %>">

            <div class="col-md-9 pt-0">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="font-weight-bold">ADD NEW ADDRESS</h5>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="toggleFormVisibility()">Toggle Form</button>
                                    </div>
                                    <form id="newAddressForm" method="post" style="display: none;" class="border p-4">
                                        <h3 class="mt-10" style="font-size: medium;">ADD A NEW ADDRESS</h3>
                                        <!-- Your form for adding a new address goes here -->
                                        <div class="mt-30">
                                            <input type="text" name="name" placeholder="Name" onfocus="this.placeholder = 'Name'"
                                                onblur="this.placeholder = 'Name'" required class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="mobile" placeholder="10-digit Mobile Number"
                                                onfocus="this.placeholder = '10-digit Mobile Number'"
                                                onblur="this.placeholder = '10-digit Mobile Number'" required
                                                class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="pincode" placeholder="Pincode"
                                                onfocus="this.placeholder = 'Pincode'" onblur="this.placeholder = 'Pincode'"
                                                required class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="address" placeholder="Address"
                                                onfocus="this.placeholder = 'Address'" onblur="this.placeholder = 'Address'"
                                                required class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="city" placeholder="City/District/Town"
                                                onfocus="this.placeholder = 'City/District/Town'"
                                                onblur="this.placeholder = 'City/District/Town'" required
                                                class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="state" placeholder="State" onfocus="this.placeholder = 'State'"
                                                onblur="this.placeholder = 'State'" required class="single-input-primary">
                                        </div>
                                  
                                  
                                        <div class="mt-10">
                                            <input type="text" name="landmark" placeholder="Landmark (optional)"
                                                onfocus="this.placeholder = 'Landmark (optional)'"
                                                onblur="this.placeholder = 'Landmark (optional)'" required
                                                class="single-input-primary">
                                        </div>
                                  
                                        <div class="mt-10">
                                            <input type="text" name="alternateMobile" placeholder="Alternate Phone (optional)"
                                                onfocus="this.placeholder = 'Alternate Phone (optional)'"
                                                onblur="this.placeholder = 'Alternate Phone (optional)'" required
                                                class="single-input-primary">
                                        </div>
                                        <div class="mt-30"></div>
                                        <button type="submit" class="genric-btn primary-border">SAVE THE ADDRESS</button>
                                  
                                    </form>
                                </div>
                            </div>
                        </div>

                        <% if (user && user.addresses && user.addresses.length > 0) { %>
                            <% user.addresses.forEach((address, index) => { %>
                                <div class="col-lg-3">
                                    <div class="address-item">
                                        <input class="form-check-input" type="radio" name="selectedAddress" id="address_<%= address._id %>" value="<%= address._id %>" required>
                                        <!-- Display existing address details -->
                                        <strong><%= address.name %></strong><br>
                                        <%= address.mobile %>,<br>
                                        <%= address.address %>,<br>
                                        <%= address.city %>,<br>
                                        <%= address.state %> - <%= address.pincode %>,<br>
                                        <%= address.landmark %>,<br>
                                        <%= address.alternateMobile %><br><br>
                                        <!-- Edit link -->
                                        <a href="/editAddress/<%= address._id %>" class="btn btn-sm btn-primary mr-2 edit-address-btn">Edit</a>
                                        <!-- Delete button -->
                                        <button class="btn btn-sm btn-danger delete-address-btn" data-address-id="<%= address._id %>">Delete</button>
                                    </div>
                                </div>
                                <% if ((index + 1) % 4 === 0) { %>
                                    </div><div class="row">
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <div class="col-lg-12">
                                <p>No saved addresses. Please add an address in your profile.</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript"></script>
  <script src="/js/jquery-1.12.1.min.js"></script>
  <!-- popper js -->
  <script src="/js/popper.min.js"></script>
  <!-- bootstrap js -->
  <script src="/js/bootstrap.min.js"></script>
  <!-- easing js -->
  <script src="/js/jquery.magnific-popup.js"></script>
  <!-- swiper js -->
  <script src="/js/swiper.min.js"></script>
  <!-- swiper js -->
  <script src="/js/masonry.pkgd.js"></script>
  <!-- particles js -->
  <script src="/js/owl.carousel.min.js"></script>
  <script src="/js/jquery.nice-select.min.js"></script>
  <!-- slick js -->
  <script src="/js/slick.min.js"></script>
  <script src="/js/jquery.counterup.min.js"></script>
  <script src="/js/waypoints.min.js"></script>
  <script src="/js/contact.js"></script>
  <script src="/js/jquery.ajaxchimp.min.js"></script>
  <script src="/js/jquery.form.js"></script>
  <script src="/js/jquery.validate.min.js"></script>
  <script src="/js/mail-script.js"></script>
  <script src="/js/stellar.js"></script>
  <script src="/js/price_rangs.js"></script>
  <!-- custom js -->
  <script src="/js/custom.js"></script>
  <script>
    function toggleFormVisibility() {
        let form = document.getElementById("newAddressForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
    }
  
  
    $(document).ready(function() {
    $("#newAddressForm").submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        // Use AJAX to send the form data to the server
        $.ajax({
            type: "POST",
            url: "/addressManage", // Adjust the URL based on your server configuration
            data: $(this).serialize(),
            dataType: "json",
            success: function(response) {
                console.log('Response:', response);

                if (response.success) {
                    $("#message").text(response.message);
                    window.location.reload();
                } else {
                    console.error(response.message);
                }
            },
            error: function(error) {
                console.error("Error:", error);
            }
        });
    });
});

  
  </script> 

<script>
    // Function to handle click event on edit buttons
    document.addEventListener('DOMContentLoaded', function() {
        const editButtons = document.querySelectorAll('.edit-address-btn');

        editButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                // Check if a radio button is selected
                const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');
                if (!selectedRadio) {
                    alert('Please select an address to edit.');
                    event.preventDefault()
                    return false;
                }

                const addressId = selectedRadio.value; // Retrieve the address ID from the selected radio button

                // Ask for confirmation before redirecting
                if (confirm('Are you sure you want to edit this address?')) {
                    // Redirect to the edit page with the selected address ID
                    window.location.href = `/editAddress/${addressId}`;
                }
                else{
                    event.preventDefault()
                }
            });
        });
    });

    // Function to handle click event on delete buttons
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.delete-address-btn');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                // Check if a radio button is selected
                const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');
                if (!selectedRadio) {
                    alert('Please select an address before deleting.');
                    return;
                }

                const addressId = selectedRadio.value;
                const userId = document.getElementById('userId').value; // Retrieve userId from hidden input

                // Make a DELETE request to delete the address
                deleteAddress(userId, addressId);
            });
        });
    });

    // Function to send DELETE request to delete an address
    function deleteAddress(userId, addressId) {
        // Construct the URL for the DELETE request
        const url = `/deleteAddress/${addressId}`; // Use the delete route

        // Send the DELETE request using AJAX
        $.ajax({
            url: url,
            type: 'DELETE',
            contentType: 'application/json',
            success: function(data) {
                console.log(data); // Log success response
                location.reload();
            },
            error: function(xhr, textStatus, errorThrown) {
                console.error('Error deleting address:', errorThrown);
            }
        });
    }
</script>


    
  </body>

  </html>